---
title: "病毒逃逸分析 V1"
date: 2022-08-31T10:07:54+08:00
draft: true
---

### 问题描述

在Windows沙箱下，1： 病毒的逃逸手段，2：针对逃逸，检测病毒逃逸行为(暴露病毒行为进行分析)，3：（可选)python检测病毒是否逃逸。

### 前置知识点

1. 常见的病毒种类：僵尸网络，勒索软件，木马，蠕虫。

2. 恶意代码分析方式：

   1. 静态代码分析，静态特征码，静态启发式扫描
   2. 动态环境分析：行为检测
   3. 网络流量检测
   4. 启发式扫描
   5. 系统调用行为分析
   6. 沙箱

3. 病毒检测

   了解检测方式需要了解病毒常见的逃逸行为和常见的攻击方式。

4. 沙箱： 动态分析环境，隔离关键的进程，内存数据，注册表，并用cow方式不修改系统环境，或者重定向方式进行文件操作。

5. 沙箱分类：
   1. 基于虚拟化的沙箱，包括系统层次沙箱和容器层次沙箱。
      1. 系统层次，虚拟化或半虚拟化或者容器化，需要安装操作系统，可以内部检测可以外部检测。
   2. 基于规则的沙箱，通过访问规则和程序控制，进程监控等进行权限分离。容易被逃逸沙箱检测。	

### 逃逸手段

病毒先不关注环境，默认可能添加的隐藏方式:

#### 隐藏方式

在不同阶段有不同的逃避方式：

1. 避免被沙箱进行动态分析时候检测到，同时规避行为分析技术进行恶意代码分析。例如添加环境检测，检测虚拟机、沙箱等行为，进行环境判定。
2. 隐藏恶意行为，减少攻击面，减少捕获机会。其中包括仅在特定环境下才会进行重要目标的攻击。
3. 不考虑具体环境，直接做相关的代码混淆，进程/注册表/通信端口隐藏，文件附加隐藏，Rootkit等。
4. 云逃逸，只先扫描可能的漏洞，再去根据漏洞和安装的软件情况，通过下载其他的特定的病毒来提权，



### 沙箱检测逃逸

#### 针对沙箱技术特点的逃逸技术（主机特征)

1. 检测是否是虚拟机，
   1. vmware检测通信端口，虚拟网卡，可能的管理插件。
   2. 其他的环境有利用LDT和GDT进行分析，redpill。
   3. 利用真实机和虚拟机的不同运行时间判断，
   4. 虚拟机有些代码的执行时间比真实环境时间更长。
   5. 利用CPU的模拟环境的不同。
   6. 利用特殊指令集，如二进制翻译设定的特殊指令VERR等方式判定。
   7. 温度检查
2. 虚拟机信息特点检测，承接上文部分。
   1. 如vmware的注册表信息，
   2. 如检测硬件信息的硬盘环境等。
   3. 检测进程信息。
   4. 驱动文件等如vmci等等。
   5. 虚拟机硬件信息的指纹参数。
3. 代码嵌入和汇编，通过嵌入到某一程序上的某个函数，嵌入一段汇编指令判断。

#### 针对沙箱分析环境特点的逃逸技术

1. 时间特点：沙箱分析样本时间一般有限，非主动式防御，通过sleepEx()函数可以自身休眠躲避，
   1. 直接不使用sleep，写循环代码执行较长时间
   2. 仅在特定时间进行的相关代码的执行，如CIH病毒。
2. 交互特点：部分样本检测鼠标点击等操作判断是否处于沙箱环境，只有出现单击事件后才会触发恶意代码部分。
   1. 通过部分弹出窗口或者模拟某些软件的页面来获取权限或者通过真实用户点击确认，点击后执行恶意代码。
   2. 监控鼠标移动，监控鼠标移动范围，不动或者长时间不断移动判断是处于沙箱环境。
3. 特定沙箱的环境，运行机制：仅在特定的环境中判断。如txt文件和rtf文件等某一特定API。
   1. 恶意代码移除特定监控的内核指针的注册函数。
   2. 沙箱一般不会重启判断检测，而且是一定时间窗口的检测，恶意代码在系统重启之后才会触发恶意行为。
   3. 例如仅在用户调用ODBC的函数库时候才会执行样本。例如在代码中增加检测SMB协议版本、NFS协议版本和指定漏洞，数据库检测等。
   4. 没有打上的补丁。
4. 沙箱漏洞： 检测沙箱漏洞逃逸出。0day漏洞等。

#### 恶意代码的常用逃逸行为

这里在沙箱中先尝试一些高危操作，判断是否环境可以执行复杂的更加严重的恶意操作（是否可以执行权限更高的操作不被发现）。

1. 文件操作行为，增删改查。
2. 网络通信行为，与C&C服务器通信，作为触发。
3. 进程操作内容，线程注入到其他进程执行操作。
4. 注册表操作，键值查询和部分表先修改，判断是否有对应沙箱环境。
5. 交互判断时间/鼠标操作/延时操作。

#### 沙箱检测逃逸前的应对手段

1. 沙箱环境单一，有明显环境特征，容易被检测。改进：
   1. 透明化沙箱，减少特征。
   2. 环境自动变化，制造各类用户模拟环境，使病毒判断可以进行攻击。这里甚至可以专门设置没有补丁的沙箱环境。这里偏向蜜罐和密网。
   3. 调整相关函数的执行方式，加快病毒的检测速度。
   4. 函数部分劫持，防止被劫持和被发现，同时注入监控代码。
2. 单个样本同时进入多个不同类型的沙箱测试环境，在不同环境下表现出的不同行为与真实环境进行对比后分析。用来判定攻击面。人为模拟真实环境，提供模拟和虚假的账户和文件访问（欺骗防御技术）。
3. 深度解析扫描。通过解开各种混淆包或者添加到常用文件内层（如rar，txt，word)等方式获取到真实的恶意代码文件，再进行比对分析。这里是前言说的静态分析，也有启发式扫描等。(脱壳技术)
4. 网络包检测和扫描。



#### 沙箱检测逃逸后的应对手段

1. 检测和日志收集
   1. api hook与环境初始化/环境恢复
   2. 真实环境对比
   3. 不同沙箱分析环境配合，增大病毒的检测量
   4. 各种组件的日志情况下的记录，行为特征等的记录，全链路的变化状态和全链路的行为记录。
2. 对应行为文件的处理
   1. 环境初始化时候添加正常软件和可能的环境变化，如注册表，账户名称，机器名等，增加随机度。
   2. 日志提取和特征筛选。
   3. 监控关键API的进程函数调用。通过特征点的数量比对判断是否是由高位行为。
3. 判定对应的行为的严重程度
   1. 相似度判定，与标准样本的代码特征做相似度判定。
   2. 与真实环境下的对应行为文件进行对比分析，判断差异性，如果差异较大且高于阈值（或者在部分区间内），可以判定出现逃逸行为，同时多个环境对比可以判定可能出现多个不同沙箱的逃逸行为。
   3. 统计学或者机器学习或者数据挖掘的方式判断特征。



### 第三问 python检测逃逸

目前看是要实现反恶意代码的痕迹检查和关键点位的动作是否被触发。需要用常用的安全分析的沙箱，cuckoo/ BitBlaze等，沙箱有支持脚本。此外调试器有支持脚本。更复杂的API劫持这个不了解，应该要写C++吧？。看了下检测一些提权的代码的方式指向shell的，短时间内无法推进。

比较简单的可以设定一个限制了python的包安装和subprocess的执行环境。并尝试在限制了权限的情况下提权。这里用正则或者限制模块安装条件等方式解决。



## Extra

虚拟机逃逸技术，通过检测虚拟机的漏洞获取宿组机权限。例如软件的段溢出或者堆栈溢出。

沙箱与恶意样本的自动化分析和检测。多平台测试流程自动化。

匿名方式-如何隐藏自己在网络上的痕迹，远程控制/木马的痕迹清理和现场恢复。

kata-container 轻量级qemu-kvm环境。

Wireshark网络流量分析。







